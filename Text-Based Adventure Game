import math
import random
import time
from random import randint

character_classes = {
    "warrior": {"attack": 20, "health": 100, "gold": 0},
    "thief": {"attack": 25, "health": 75, "gold": 0},
    "mage": {"attack": 35, "health": 40, "gold": 0},
    "large_monster": {"attack": 35, "health": 70, "gold": 15},
    "medium_monster": {"attack": 20, "health": 50, "gold": 10},
    "small_monster": {"attack": 15, "health": 30, "gold": 5},
}

enemies = {
    "turn_bracket1": { # Used for turns 0-20
        "warrior": ("Brigand", "Pirate"),
        "thief": ("Burglar", "Assassin"),
        "mage": ("Warlock", "Witch"),
        "large_monster": ("Bear",),
        "medium_monster": ("Goblin",),
        "small_monster": ("Slime",),
    },
    "turn_bracket2": {  # Used for turns 21-40
        "warrior": ("Barbarian", "Ogre"),
        "thief": ("Crime Boss", "Bandit Scout"),
        "mage": ("Spellsword", "Demon Priest"),
        "large_monster": ("Giant",),
        "medium_monster": ("Goblin Shaman",),
        "small_monster": ("Giant Rat",),
    },
    "turn_bracket3": {  # Used for turns 41-60
        "warrior": ("Knight", "Orc"),
        "thief": ("Nightblade", "Demon"),
        "mage": ("Archmage", "Sorcerer"),
        "large_monster": ("Dragon",),
        "medium_monster": ("Orc Chieftain",),
        "small_monster": ("Giant Slime",),
    }
}

# Classes
class character: 
    def __init__(self, name, character_class):
        self.name = name
        self.health = character_classes.get(character_class).get("health")
        self.health_max = character_classes.get(character_class).get("health")
        self.attack = character_classes.get(character_class).get("attack")

    def change_health_max(self, amount, multiplier):
        amount = amount * multiplier
        self.health_max += amount
        time.sleep(0.25)
        print("\nYou now have", self.health_max, "maximum health.")

class player(character):
    def __init__(self, name, character_class, gold, turns):
        super().__init__(name, character_class)
        self.score = 0
        self.attack_max = 500
        self.turns = turns
        self.gold = gold

    def change_gold(self, amount, multiplier):
        gold_change_value = amount * multiplier
        self.gold += gold_change_value
        time.sleep(0.25)
        if self.gold <= 0:
            self.gold = 0
        if gold_change_value > 0:
            print("\nYou gained", gold_change_value, "gold! You now have", self.gold, "gold.")
        elif gold_change_value == 0:
            print("\nYou did not gain any gold from this encounter.")
        elif gold_change_value < 0:
            print("\nYou lost", -gold_change_value, "gold! You now have", self.gold, "gold.")

    def change_attack(self, amount, multiplier):
        amount = amount * multiplier
        self.attack += amount
        if self.attack >= getattr(self, "attack_max", 500):
            self.attack = getattr(self, "attack_max", 500)
            time.sleep(0.25)
            print("\nYou gained", amount, "attack! \nYou now have", self.attack, "attack points and can no longer raise your maximum attack.")
        else:
            time.sleep(0.25)
            print("\nYou gained", amount, "attack! \nYou now have", self.attack, "out of", self.attack_max, "possible attack points.")

    def change_turns(self, amount, multiplier):
        amount = amount * multiplier
        self.turns += amount
        time.sleep(0.25)
        if self.health <= 0:
            print("\nFinal Stats: \nHealth:", self.health, "\nMaximum Health:", self.health_max, "\nAttack:", self.attack, "\nGold:", self.gold)
        else:
            print("\nYou have been adventuring for", self.turns, "months (turns).")
            time.sleep(0.25)
            print("\nCurrent Status:\nHealth:", self.health, "\nMaximum Health:", self.health_max, "\nAttack:", self.attack, "\nGold:", self.gold)

    def change_health(self, amount, multiplier):
        #multiplier: typically 1 or -1 (to add/subtract)
        health_change_value = amount * multiplier
        prev_health = self.health
        self.health += health_change_value
        if self.health <= 0:
            self.health = 0
            time.sleep(0.25)
            print("\nYou lost", -health_change_value, "health. \nYou now have", self.health, "out of", self.health_max, "possible health points.")
            self.death_function()
            return
            
        if self.health >= self.health_max:
            healed_amount = self.health_max - prev_health if health_change_value > 0 else 0
            self.health = self.health_max
            if health_change_value > 0:
                time.sleep(0.25)
                print("\nYou gained", healed_amount, "health!", "\nYou now have", self.health, "health points and have reached your maximum health capacity.")
            else:
                time.sleep(0.25)
                print("\nYou lost", -health_change_value, "health. \nYou now have", self.health, "out of", self.health_max, "possible health points.")
        else:
            if health_change_value > 0:
                time.sleep(0.25)
                print("\nYou gained", health_change_value, "health! \nYou now have", self.health, "out of", self.health_max, "possible health points.")
            else:
                time.sleep(0.25)
                print("\nYou lost", -health_change_value, "health. \nYou now have", self.health, "out of", self.health_max, "possible health points.")

    def attack_opponent(self, opponent):
        swing_chance = random.randint(1, 6)
        if swing_chance == 1:
            time.sleep(0.25)
            print("\nYour attack missed!")
        elif swing_chance > 1:
            time.sleep(0.25)
            print("\nYour attack was successful!")
            opponent.change_health(self.attack, -1)
            if opponent.health <= 0:
                if hasattr(opponent, "gold"):
                    self.change_gold(opponent.gold, 1)
                return True
        counter_chance = random.randint(1, 4)
        if counter_chance == 1 or counter_chance == 2:
            time.sleep(0.25)
            print("\nThe", opponent.name, "missed its attack!")
        elif counter_chance == 3 or counter_chance == 4:
            time.sleep(0.25)
            print("\nThe", opponent.name, "attacked you!")
            self.change_health(opponent.attack, -1)
        else:
            time.sleep(0.25)
            print("\nYou failed to escape from the", opponent.name, "\nLuckily, you managed to evade their attacks.")

    def run_from_opponent(self, opponent):
        run_chance = random.randint(1, 3)
        if run_chance == 1:
            time.sleep(0.25)
            print("\nYou successfully escaped from the", opponent.name)
            return True
        else:
            time.sleep(0.25)
            print("\nYou failed to escape from the", opponent.name)
            print("\nYou have been hit by the", opponent.name)
            self.change_health(opponent.attack, -1)

    @staticmethod
    def ask_name():
        time.sleep(0.25)
        chosen_name = input("\nWhat is your name, adventurer?: ")
        return chosen_name

    @staticmethod
    def ask_character_class():
        while True:
            time.sleep(0.25)
            chosen_character_class = input("\nChoose your starting class: \n(W)arrior: (Health: 100, Attack: 20, Gold: 0) \n(T)hief: (Health: 75, Attack: 25, Gold: 0) \n(M)age: (Health: 40, Attack: 35, Gold: 0) \n: ")
            try:
                if chosen_character_class.upper() == "W":
                    return "warrior"
                elif chosen_character_class.upper() == "T":
                    return "thief"
                elif chosen_character_class.upper() == "M":
                    return "mage"
                else:
                    time.sleep(0.25)
                    print("\nInvalid input. Please enter W, T, or M.")
            except ValueError:
                time.sleep(0.25)
                print("\nInvalid input. Please enter W, T, or M.")

    @staticmethod
    def ask_gold():
        while True:
            time.sleep(0.25)
            chosen_gold = input("\nHow much gold have you gathered on your adventures? (0 is recommended for new players): ")
            try:
                return int(chosen_gold)
            except ValueError:
                time.sleep(0.25)
                print("\nInvalid input. Please enter a number.")

    @staticmethod
    def ask_turns():
        while True:
            time.sleep(0.25)
            chosen_turns = input("\nHow many months have you been adventuring for? (0-12, 0 is recommended for new players): ")
            try:
                if int(chosen_turns) <= 12 and int(chosen_turns) >= 0:
                    return int(chosen_turns)
                else:
                    time.sleep(0.25)
                    print("\nInvalid input. Please enter a number between 0 and 12.")
            except ValueError:
                time.sleep(0.25)
                print("\nInvalid input. Please enter a number.")

    def healing_function(self):
        random_health = randint(25, 40)
        self.change_health(random_health, 1)

    def atk_function(self):
        random_atk = randint(25, 40)
        self.change_attack(random_atk, 1)

    def death_function(self):
        while True:
            time.sleep(0.25)
            print("\nYou have been defeated.")
            restart_occurence = input("\nRestart? Y/N: ").upper()
            if restart_occurence == "Y":
                time.sleep(0.25)
                print("\n\nRestarting...")
                game_main()
                return
            elif restart_occurence == "N":
                time.sleep(0.25)
                print("\n\nGame over.")
                quit()
            else:
                time.sleep(0.25)
                print("\n\nEnter a valid input.")

    def shop_function(self):
        if self.gold > 0:
            healing_cost = randint(7,25) # arbitrary value set to change
            atk_cost = randint(5,25)  # arbitrary value set to change
            while True:
                time.sleep(0.25)
                general_shop_choice = input("\nWould you like add (H)ealing, increase your (A)ttack, or (E)xit?: ").upper()
                if general_shop_choice == "H":
                    time.sleep(0.25)
                    print("\nYou have", self.gold, "gold. \nWould you like to heal and/or raise your maximum health for", healing_cost, "gold?")
                    healing_shop_choice = input("Y/N: ").upper()
                    if healing_shop_choice == "Y":
                        if self.health == self.health_max:
                            time.sleep(0.25)
                            print("Your health is already at its maximum.")
                            return
                        else:
                            if self.gold >= healing_cost:
                                self.gold -= healing_cost
                                time.sleep(0.25)
                                print("\n\nYou now have", self.gold, "gold.")
                                self.healing_function()
                            else:
                                time.sleep(0.25)
                                print("\nYou do not have the necessary amount to purchase this.")
                elif general_shop_choice == "A":
                    time.sleep(0.25)
                    print("\nYou have", self.gold, "gold. \nWould you like to raise your attack for", atk_cost, "gold?")
                    atk_shop_choice = input("Y/N: ").upper()
                    if atk_shop_choice == "Y":
                        if self.attack == getattr(self, "attack_max", 500):
                            time.sleep(0.25)
                            print("\nYour attack is already at its maximum.")
                            return
                        else:
                            if self.gold >= atk_cost:
                                self.gold -= atk_cost
                                time.sleep(0.25)
                                print("\n\nYou now have", self.gold, "gold.")
                                self.atk_function()
                            else:
                                time.sleep(0.25)
                                print("\nYou do not have the necessary amount to purchase this.")
                elif general_shop_choice == "E":
                    time.sleep(0.25)
                    print("Successfully exited shop...")
                    break
                else:
                    time.sleep(0.25)
                    print("\n\nEnter a valid input.")

    def random_event_shrine(self):
        if self.health >= self.health_max:
            time.sleep(0.25)
            print("\nYou found a healing shrine but your health is already full!")
            return

        while True:
            time.sleep(0.25)
            shrine_occurence = input("\nYou have stumbled upon a mysterious shrine. Will you take a closer look? \nY/N: ").upper()
            if shrine_occurence == "Y":
                heal_or_poison = randint(4, 25)
                if heal_or_poison >= 7:
                    time.sleep(0.25)
                    print("\nYou have discovered a healing shrine!")
                    self.healing_function()
                    break
                else:
                    random_poison = randint(1, 10)
                    self.change_health(random_poison, -1)
                    break
            elif shrine_occurence == "N":
                time.sleep(0.25)
                print("\nYou decided to not take the risk.")
                break
            else:
                time.sleep(0.25)
                print("\nEnter a valid input.")

    def random_event_chest(self):
        while True:
            time.sleep(0.25)
            gold_occurence = input("\nYou have stumbled upon a chest. Will you take a closer look? \nY/N: ").upper()
            if gold_occurence == "Y":
                random_gold_amount = randint(1, 7)
                gain_or_lose_gold = randint(0, 20)
                if gain_or_lose_gold == 18:
                    random_chest_damage_amount = randint(1, 8)
                    time.sleep(0.25)
                    print("\nThe chest turned out to be trapped!")
                    self.change_gold(random_gold_amount, -1)
                    self.change_health(random_chest_damage_amount, -1)
                    time.sleep(0.25)
                elif gain_or_lose_gold >= 13:
                    time.sleep(0.25)
                    print("\nThe chest was trapped!")
                    self.change_gold(random_gold_amount, -1)
                else:
                    self.change_gold(random_gold_amount, 1)
                    time.sleep(0.25)
                break
            elif gold_occurence == "N":
                time.sleep(0.25)
                print("\nYou decided to not take the risk.")
                break
            else:
                time.sleep(0.25)
                print("\nEnter a valid input.")

    def random_event_shop(self):
        time.sleep(0.25)
        print("\nYour adventure has brought you to a shop!")
        self.shop_function()

    def random_event_ambush(self):
        time.sleep(0.25)
        print("\nYou have been ambushed!")
        enemy_name = random.choice(enemies["turn_bracket1"]["small_monster"])
        combat_sequence(self, enemy_name, "small_monster")

    def random_event_cheap_potion(self):
        time.sleep(0.25)
        print("\nYou were passing through a humble village when a small, old woman tapped you on the shoulder, offering you a cheap potion. She claims it is a potion of vitality.")
        while True:
            time.sleep(0.25)
            print("\nYou currently have", self.health, "heatlh and", self.gold, "gold.")
            answer = input("\nWould you like to (B)uy the cheap potion for 5 gold or (W)alk away?: ")
            if answer.upper() == "B":
                if self.gold >= 5:
                    time.sleep(0.25)
                    print("\nYou decided to purchase the cheap vitality potion from the old woman.")
                    poison_chance = randint(1,50)
                    if poison_chance == 1:
                        print("\nThe cheap potion turned out to be poisonous!")
                        random_poison = randint(1, 5)
                        self.change_health(random_poison, -1)
                    else:
                        self.change_gold(5, -1)
                        self.change_health_max(10, 1)
                    break
                else:
                    time.sleep(0.25)
                    print("\nYou do not have enough gold to purchase the potion, the old woman grunts and walks away.")
                    break
            elif answer.upper() == "W":
                random_woman_choice = randint(1,10)
                if random_woman_choice <= 3:
                    if self.gold == 0:
                        print("\nThe woman feels bad for you and gifts you some gold.")
                        player1.change_gold(randint(5,8),1)
                        break
                    else:
                        print("\nThe woman knows you're carrying gold so she decides to punch you for not giving her any.")
                        damage = randint(1,5)
                        player1.change_health(damage, -1)
                        break
                else:
                    time.sleep(0.25)
                    print("\nYou keep your eyes straight and walk past the woman. (nothing happens)")
                    break

    def random_event_doctor(self):
        time.sleep(0.25)
        print("\nYou come across a small cabin, the sole resident claiming to be an experienced doctor.")
        while True:
            time.sleep(0.25)
            answer = input("\nWould you like to (C)heck your condition (displays all stats), (W)alk away, or (K)ill the doctor and loot their home?: ")
            if answer.upper() == "C":
                time.sleep(0.25)
                print("\nHealth: ", self.health, "\nMaximum Health: ", self.health_max, "\nAttack: ", self.attack, "\nGold: ", self.gold, "\nMonths (turns) survived: ", self.turns)
                break
            elif answer.upper() == "W":
                time.sleep(0.25)
                print("\nYou walk away from the doctor. (nothing happens)")
                break
            elif answer.upper() == "K":
                time.sleep(0.25)
                print("\nYou killed the doctor and loot their cabin")
                self.change_gold(random.randint(1, 50), 1)
                break
    def random_event_gain_gold(self):
        time.sleep(0.25)
        random_gold = randint(5,10)
        self.gold += random_gold
        print("\nDuring your travels, you stumbled upon", random_gold, "gold!. You now have", self.gold, "gold.")
        
    def random_event_gain_attack(self):
        print("\nYou stumble upon a blacksmith, they offer to increase your weapon's attack at no extra cost!")
        self.change_attack(randint(1,25),1)
        
        

        

class enemy(character):
    def __init__(self, name, character_class):
        super().__init__(name, character_class)
        self.gold = character_classes.get(character_class).get("gold")

    def change_health(self, amount, multiplier):
        amount = amount * multiplier
        self.health += amount
        if self.health >= self.health_max:
            self.health = self.health_max
        time.sleep(0.25)
        if self.health <= 0:
            self.health = 0
            print("You have defeated the enemy!")
        else:
            print("\nThe enemy has", self.health, "out of", self.health_max, "possible health points.")

def combat_sequence(player_obj, name, class_type):
    opponent = enemy(name, class_type)
    multiplier = 2 
    if player_obj.turns <= 20:
        multiplier = 1.0
    elif player_obj.turns <= 40:
        multiplier = 1.5
    opponent.health = int(opponent.health * multiplier)
    opponent.health_max = int(opponent.health_max * multiplier)
    opponent.attack = int(opponent.attack * multiplier)
    opponent.gold = int(opponent.gold * multiplier)
    time.sleep(0.25)
    print("\nYou have encountered a(n)", name,)
    escaped = False
    victorious = False
    dead = False
    while not escaped and not victorious and not dead:
        time.sleep(0.25)
        print("\nThe enemy has", opponent.health, "health and", opponent.attack, "attack.")
        response = input("\nDo you decide to (A)ttack or attempt to (R)un?: ")
        if response.upper() == "A":
            kill = player_obj.attack_opponent(opponent)
            if kill:
                victorious = True
        elif response.upper() == "R":
            attempt = player_obj.run_from_opponent(opponent)
            if attempt:
                escaped = True
        else:
            time.sleep(0.25)
            print("\nInvalid input. Please enter A or R.")
        if player_obj.health <= 0:
            dead = True

def generate_event(player_obj):
    type_select = random.randint(1, 2)
    if type_select == 1:
        event_pool = [
            lambda p: p.random_event_cheap_potion(),  
            lambda p: p.random_event_doctor(),        
            lambda p: p.random_event_shrine(),  
            lambda p: p.random_event_chest(),   
            lambda p: p.random_event_shop(),    
            lambda p: p.random_event_ambush(),
            lambda p: p.random_event_gain_gold(),
            lambda p: p.random_event_gain_attack()
        ]
        random.choice(event_pool)(player_obj)
    elif type_select == 2:
        bracket_level = 0
        if player_obj.turns <= 20:
            bracket_level = enemies["turn_bracket1"]
        elif player_obj.turns <= 40:
            bracket_level = enemies["turn_bracket2"]
        else:
            bracket_level = enemies["turn_bracket3"]
        enemy_class_type = random.choice(list(bracket_level.keys()))
        enemy_name = random.choice(bracket_level[enemy_class_type])
        combat_sequence(player_obj, enemy_name, enemy_class_type)

def game_main():
    alive = True
    print("The princess has been kidnapped by evil-doers and the responsibility to save her falls into your hands!")
    player1 = player(player.ask_name(), player.ask_character_class(), player.ask_gold(), player.ask_turns())
    while player1.turns <= 60 and alive == True:
        generate_event(player1)
        player1.change_turns(1, 1)
        if player1.health <= 0:
            alive = False
            player1.death_function()
            break
        else:
            time.sleep(0.25)
            print("\nYou resume your journey, searching for the princess.")
            time.sleep(3)
    if alive == False:
        time.sleep(0.25)
        print("\nYou have failed in your mission to save the princess. You will forever got down in history as a failure!")
    else:
        time.sleep(0.25)
        print("\nCongratulations! You saved the princess from certain doom. You can now live the rest of your days in peace.")

if __name__ == "__main__":
    game_main()
